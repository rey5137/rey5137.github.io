<!DOCTYPE html>
<html lang="en">
<head>

    <title>Power up your REST service with Batch API</title>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="HandheldFriendly" content="True" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link rel="stylesheet" type="text/css" href="/assets/built/screen.css?v=819dc3dcc5" />

    <meta name="description" content="A different approach with GraphQL, that can quickly integrate into your REST service without the need to define any schema." />
    <link rel="canonical" href="http://localhost:2368/power_up_rest_service_with_batch_api/" />
    <meta name="referrer" content="no-referrer-when-downgrade" />
    <link rel="amphtml" href="http://localhost:2368/power_up_rest_service_with_batch_api/amp/" />
    
    <meta property="og:site_name" content="Rey Pham" />
    <meta property="og:type" content="article" />
    <meta property="og:title" content="Power up your REST service with Batch API" />
    <meta property="og:description" content="A different approach with GraphQL, that can quickly integrate into your REST service without the need to define any schema." />
    <meta property="og:url" content="http://localhost:2368/power_up_rest_service_with_batch_api/" />
    <meta property="og:image" content="https://i.imgur.com/hqxvO54.jpg" />
    <meta property="article:published_time" content="2020-07-10T09:42:30.000Z" />
    <meta property="article:modified_time" content="2020-07-10T09:42:30.000Z" />
    <meta property="article:tag" content="Java" />
    <meta property="article:tag" content="Batch" />
    <meta property="article:tag" content="JSON" />
    <meta property="article:tag" content="Springboot" />
    <meta property="article:tag" content="Import 2022-11-24 07:18" />
    
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="Power up your REST service with Batch API" />
    <meta name="twitter:description" content="A different approach with GraphQL, that can quickly integrate into your REST service without the need to define any schema." />
    <meta name="twitter:url" content="http://localhost:2368/power_up_rest_service_with_batch_api/" />
    <meta name="twitter:image" content="https://i.imgur.com/hqxvO54.jpg" />
    <meta name="twitter:label1" content="Written by" />
    <meta name="twitter:data1" content="Rey Pham" />
    <meta name="twitter:label2" content="Filed under" />
    <meta name="twitter:data2" content="Java, Batch, JSON, Springboot, Import 2022-11-24 07:18" />
    <meta property="og:image:width" content="2000" />
    <meta property="og:image:height" content="884" />
    
    <script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "Article",
    "publisher": {
        "@type": "Organization",
        "name": "Rey Pham",
        "url": "http://localhost:2368/",
        "logo": {
            "@type": "ImageObject",
            "url": "http://localhost:2368/favicon.ico",
            "width": 48,
            "height": 48
        }
    },
    "author": {
        "@type": "Person",
        "name": "Rey Pham",
        "image": {
            "@type": "ImageObject",
            "url": "//www.gravatar.com/avatar/cd4c74c822ad731f7f283008b81d597d?s=250&d=mm&r=x",
            "width": 250,
            "height": 250
        },
        "url": "http://localhost:2368/author/rey-2/",
        "sameAs": []
    },
    "headline": "Power up your REST service with Batch API",
    "url": "http://localhost:2368/power_up_rest_service_with_batch_api/",
    "datePublished": "2020-07-10T09:42:30.000Z",
    "dateModified": "2020-07-10T09:42:30.000Z",
    "keywords": "Java, Batch, JSON, Springboot, Import 2022-11-24 07:18",
    "description": "A different approach with GraphQL, that can quickly integrate into your REST service without the need to define any schema. ",
    "mainEntityOfPage": {
        "@type": "WebPage",
        "@id": "http://localhost:2368/"
    }
}
    </script>

    <meta name="generator" content="Ghost 5.23" />
    <link rel="alternate" type="application/rss+xml" title="Rey Pham" href="http://localhost:2368/rss/" />
    <script defer src="https://cdn.jsdelivr.net/ghost/portal@~2.20/umd/portal.min.js" data-ghost="http://localhost:2368/" data-key="cacff2152241882fce973f1f10" data-api="http://localhost:2368/ghost/api/content/" crossorigin="anonymous"></script><style id="gh-members-styles">.gh-post-upgrade-cta-content,
.gh-post-upgrade-cta {
    display: flex;
    flex-direction: column;
    align-items: center;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
    text-align: center;
    width: 100%;
    color: #ffffff;
    font-size: 16px;
}

.gh-post-upgrade-cta-content {
    border-radius: 8px;
    padding: 40px 4vw;
}

.gh-post-upgrade-cta h2 {
    color: #ffffff;
    font-size: 28px;
    letter-spacing: -0.2px;
    margin: 0;
    padding: 0;
}

.gh-post-upgrade-cta p {
    margin: 20px 0 0;
    padding: 0;
}

.gh-post-upgrade-cta small {
    font-size: 16px;
    letter-spacing: -0.2px;
}

.gh-post-upgrade-cta a {
    color: #ffffff;
    cursor: pointer;
    font-weight: 500;
    box-shadow: none;
    text-decoration: underline;
}

.gh-post-upgrade-cta a:hover {
    color: #ffffff;
    opacity: 0.8;
    box-shadow: none;
    text-decoration: underline;
}

.gh-post-upgrade-cta a.gh-btn {
    display: block;
    background: #ffffff;
    text-decoration: none;
    margin: 28px 0 0;
    padding: 8px 18px;
    border-radius: 4px;
    font-size: 16px;
    font-weight: 600;
}

.gh-post-upgrade-cta a.gh-btn:hover {
    opacity: 0.92;
}</style>
    <script defer src="https://cdn.jsdelivr.net/ghost/sodo-search@~1.1/umd/sodo-search.min.js" data-key="cacff2152241882fce973f1f10" data-styles="https://cdn.jsdelivr.net/ghost/sodo-search@~1.1/umd/main.css" data-sodo-search="http://localhost:2368/" crossorigin="anonymous"></script>
    <script defer src="/public/cards.min.js?v=819dc3dcc5"></script>
    <link rel="stylesheet" type="text/css" href="/public/cards.min.css?v=819dc3dcc5">
    <script defer src="/public/member-attribution.min.js?v=819dc3dcc5"></script><style>:root {--ghost-accent-color: #FF1A75;}</style>

</head>
<body class="post-template tag-java tag-batch tag-json tag-springboot tag-import-2022-11-24-07-18 is-head-left-logo has-cover">
<div class="viewport">

    <header id="gh-head" class="gh-head outer">
        <div class="gh-head-inner inner">
            <div class="gh-head-brand">
                <a class="gh-head-logo" href="http://localhost:2368">
                        Rey Pham
                </a>
                <button class="gh-search gh-icon-btn" data-ghost-search><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" width="20" height="20"><path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg></button>
                <button class="gh-burger"></button>
            </div>

            <nav class="gh-head-menu">
                <ul class="nav">
    <li class="nav-home"><a href="https://rey5137.com/">Home</a></li>
    <li class="nav-works"><a href="https://rey5137.com/works">Works</a></li>
    <li class="nav-about"><a href="https://rey5137.com/about">About</a></li>
    <li class="nav-contact"><a href="https://rey5137.com/contact">Contact</a></li>
</ul>

            </nav>

            <div class="gh-head-actions">
                    <button class="gh-search gh-icon-btn" data-ghost-search><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" width="20" height="20"><path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg></button>
                            <a class="gh-head-button" href="#/portal/signup" data-portal="signup">Subscribe</a>
            </div>
        </div>
    </header>

    <div class="site-content">
        



<main id="site-main" class="site-main">
<article class="article post tag-java tag-batch tag-json tag-springboot tag-import-2022-11-24-07-18 no-image ">

    <header class="article-header gh-canvas">

        <div class="article-tag post-card-tags">
                <span class="post-card-primary-tag">
                    <a href="/tag/java/">Java</a>
                </span>
        </div>

        <h1 class="article-title">Power up your REST service with Batch API</h1>

            <p class="article-excerpt">A different approach with GraphQL, that can quickly integrate into your REST service without the need to define any schema. </p>

        <div class="article-byline">
        <section class="article-byline-content">

            <ul class="author-list">
                <li class="author-list-item">
                    <a href="/author/rey-2/" class="author-avatar">
                        <img class="author-profile-image" src="//www.gravatar.com/avatar/cd4c74c822ad731f7f283008b81d597d?s&#x3D;250&amp;d&#x3D;mm&amp;r&#x3D;x" alt="Rey Pham" />
                    </a>
                </li>
            </ul>

            <div class="article-byline-meta">
                <h4 class="author-name"><a href="/author/rey-2/">Rey Pham</a></h4>
                <div class="byline-meta-content">
                    <time class="byline-meta-date" datetime="2020-07-10">Jul 10, 2020</time>
                        <span class="byline-reading-time"><span class="bull">&bull;</span> 4 min read</span>
                </div>
            </div>

        </section>
        </div>


    </header>

    <section class="gh-content gh-canvas">
        <p>RESTful APIs is pretty common nowadays, as a clear and well-structured resource-oriented standard. But we often have to face the use case that requires to call multi APIs to collect all the necessary data. This quickly becomes a problem if your client is a mobile device with limited network, and only interested in a subset data of all your API responses.</p><p>A popular solution to this problem is <a href="https://graphql.org/">GraphQL</a>, a query language from Facebook. Although GraphQL is a powerful tool, it still requires you to define all the schemas &amp; functions before the client can use it. In this post, I will show you a different approach, by creating a Batch Request API, that can quickly integrate into your REST service without the need to define any schema. </p><h2 id="the-code">The code</h2><p>For a Batch Request API, we'll need an Engine that able to build &amp; execute requests sequentially, then collect all responses. For all of the hard part, I will use this <a href="https://github.com/rey5137/jsonbatch"><strong>JsonBatch</strong></a> library,  that provides many out-of-box features like: <strong>build &amp; extract JSON object, conditional &amp; looping requests, aggregate functions</strong>, ... You can test out it features <a href="https://jsonbatch-playground.herokuapp.com/sample1">here</a></p><p>Below is the code to setup a Batch Engine :</p><pre><code class="language-Java">@Bean
public BatchEngine getBatchEngine(ObjectMapper objectMapper, RequestDispatcherService dispatcherService) {
    Configuration conf = Configuration.builder()
            .options(Option.SUPPRESS_EXCEPTIONS)
            .jsonProvider(new JacksonJsonProvider(objectMapper))
            .mappingProvider(new JacksonMappingProvider(objectMapper))
            .build();
    JsonBuilder jsonBuilder = new JsonBuilder(Functions.basic());
    return new BatchEngine(conf, jsonBuilder, dispatcherService);
}</code></pre><p>And next is the Controller. The logic is quite simple, we only need to build the original request and pass it to Batch Engine along with batch template. After Batch Engine return response, we just warp it up with ResponseEntity and return.</p><pre><code class="language-Java">@RequestMapping(value = "/batch", method = RequestMethod.POST, produces = MediaType.APPLICATION_JSON_UTF8_VALUE)
public ResponseEntity batchRequests(@RequestHeader MultiValueMap&lt;String, String&gt; headers, @RequestBody BatchRequest batchRequest) {
    Request request = buildOriginalRequest(headers, batchRequest.getData());
    Response response = batchEngine.execute(request, batchRequest.getTemplate());
    return new ResponseEntity(response.getBody(), HttpStatus.resolve(response.getStatus()));
    return responseEntity;
}

private Request buildOriginalRequest(MultiValueMap&lt;String, String&gt; headers, Object body) {
    Request request = new Request();
    request.setBody(body);
    HashMap&lt;String, List&lt;String&gt;&gt; headerMap = new HashMap&lt;&gt;();
    headers.forEach(headerMap::put);
    request.setHeaders(headerMap);
    return request;
}</code></pre><p>BatchRequest is a simple Json object:</p><pre><code class="language-json">{
  "data": { input data needed to build requests }
  "template": { batch template to instruct how to build &amp; execute requests }
}</code></pre><p>We also need to implement a simple RequestDispatcher:</p><pre><code class="language-java">@Service
public class RequestDispatcherService implements RequestDispatcher {
    
    @Autowired
    private RestTemplate restTemplate;

    @Override
    public Response dispatch(Request request, JsonProvider jsonProvider, DispatchOptions options) {
        HttpHeaders requestHeaders = new HttpHeaders();
        requestHeaders.putAll(request.getHeaders());
        HttpEntity&lt;Object&gt; httpEntity = request.getBody() != null ?
                new HttpEntity&lt;&gt;(request.getBody(), requestHeaders) 
                : new HttpEntity&lt;&gt;(requestHeaders);
        ResponseEntity responseEntity = restTemplate.exchange(
                "Your service host" + request.getUrl(),
                HttpMethod.resolve(request.getHttpMethod()),
                httpEntity,
                Object.class);
        return buildResponse(responseEntity);
    }

    private Response buildResponse(ResponseEntity responseEntity) {
        Response response = new Response();
        Map&lt;String, List&lt;String&gt;&gt; headers = new HashMap&lt;&gt;();
        responseEntity.getHeaders().forEach(headers::put);
        response.setHeaders(headers);
        response.setStatus(responseEntity.getStatusCodeValue());
        response.setBody(responseEntity.getBody());
        return response;
    }

}</code></pre><p>And it's done. Now let's test it.</p><h2 id="a-real-scenario">A real scenario</h2><p>Currently in our system (a Fintech product), we have this scenario: After an user login to our system, we will retrieve all the user's information, that includes:</p><ul><li>User profile</li><li>User’s company profile</li><li>User’s wallet information</li></ul><p>Normally we have to call 4 APIs to collect all responses, but only need a subset of data. With Batch API, we only have to make a single call with request body like that:</p><pre><code>{
  "data": {
    "token": "user's token"
  },
  "template": {
    "requests": [
      {
        "http_method": "GET",
        "url": "/oauth/payload",
        "headers": {
          "Authorization": "Bearer @{$.original.body.token}@"
        },
        "body": null,
        "requests": [
          {
            "http_method": "POST",
            "url": "/report/users",
            "headers": {
              "Authorization": "Bearer @{$.original.body.token}@"
            },
            "body": {
              "id": "$.responses[0].body.data.user_id"
            },
            "requests": [
              {
                "http_method": "POST",
                "url": "/report/wallets",
                "headers": {
                  "Authorization": "Bearer @{$.original.body.token}@"
                },
                "body": {
                  "user_id": "$.responses[0].body.data.user_id"
                },
                "requests": [
                  {
                    "http_method": "POST",
                    "url": "/report/companies",
                    "headers": {
                      "Authorization": "Bearer @{$.original.body.token}@"
                    },
                    "body": {
                      "id": "$.responses[1].body.data.users[0].company_id"
                    }
                  }
                ]
              }
            ]
          }
        ]
      }
    ],
    "responses":[
      {
        "body": {
          "id": "$.responses[1].body.data.users[0].id",
          "full_name": "@{$.responses[1].body.data.users[0].first_name}@ @{$.responses[1].body.data.users[0].last_name}@",
          "email": "$.responses[1].body.data.users[0].email",
          "company": {
            "id": "$.responses[3].body.data.companies[0].id",
            "name": "$.responses[3].body.data.companies[0].name"
          },
          "wallets": [
            {
              "id": "$.id",
              "balance": "$.balance",
              "currency": "$.currency",
              "__array_schema": "$.responses[2].body.data.wallets"
            }
          ]
        }
      }
    ]
  }
}</code></pre><p>I have run a performance test with both ways. Below is the test result when run multi requests:</p><figure class="kg-card kg-image-card"><img src="https://i.imgur.com/BjPOz2b.png" class="kg-image" alt loading="lazy"></figure><p>And next is the test result when run a batch request:</p><figure class="kg-card kg-image-card"><img src="https://i.imgur.com/0U0VhVQ.png" class="kg-image" alt loading="lazy"></figure><p>As you can see, the batch request way only took on average <strong>~141 ms</strong> while the multi requests way took <strong>~369 ms</strong>.</p><p>Next, let’s look at the size of response. Below is response size when run multi requests:</p><figure class="kg-card kg-image-card"><img src="https://i.imgur.com/WXvIdb3.png" class="kg-image" alt loading="lazy"></figure><p>And here is the response size when run batch request:</p><figure class="kg-card kg-image-card"><img src="https://i.imgur.com/y9g67oK.png" class="kg-image" alt loading="lazy"></figure><p>By strip out all the unnecessary data from response, we able to reduce the response size 30+ times (9730 &gt; 272)</p><h2 id="conclusion">Conclusion</h2><p>As you can see, with a Batch API, we can archive almost same result as GraphQL without the limit of pre-defined schema.</p>
    </section>


</article>
</main>

    <section class="footer-cta outer">
        <div class="inner">
            <h2 class="footer-cta-title">Sign up for more like this.</h2>
            <a class="footer-cta-button" href="#/portal" data-portal>
                <div class="footer-cta-input">Enter your email</div>
                <span>Subscribe</span>
            </a>
        </div>
    </section>



            <aside class="read-more-wrap outer">
                <div class="read-more inner">
                        
<article class="post-card post no-image">


    <div class="post-card-content">

        <a class="post-card-content-link" href="/jsonbatch-the-jouney-part-1/">
            <header class="post-card-header">
                <div class="post-card-tags">
                </div>
                <h2 class="post-card-title">
                    JsonBatch - Journey from zero to full-fledged Batch Engine - part 1
                </h2>
            </header>
                <div class="post-card-excerpt">The idea & the first prototype</div>
        </a>

        <footer class="post-card-meta">
            <time class="post-card-meta-date" datetime="2020-06-16">Jun 16, 2020</time>
                <span class="post-card-meta-length">2 min read</span>
        </footer>

    </div>

</article>
                        
<article class="post-card post no-image">


    <div class="post-card-content">

        <a class="post-card-content-link" href="/bad-chunk-header-mystery/">
            <header class="post-card-header">
                <div class="post-card-tags">
                </div>
                <h2 class="post-card-title">
                    Bad chunk header mystery
                </h2>
            </header>
                <div class="post-card-excerpt">A case of unwanted Bad chunk header</div>
        </a>

        <footer class="post-card-meta">
            <time class="post-card-meta-date" datetime="2020-03-10">Mar 10, 2020</time>
                <span class="post-card-meta-length">2 min read</span>
        </footer>

    </div>

</article>
                        
<article class="post-card post no-image">


    <div class="post-card-content">

        <a class="post-card-content-link" href="/how-i-organize-android-project-structure/">
            <header class="post-card-header">
                <div class="post-card-tags">
                </div>
                <h2 class="post-card-title">
                    How I organize Android project structure
                </h2>
            </header>
                <div class="post-card-excerpt">Let me show you my current Android project structure</div>
        </a>

        <footer class="post-card-meta">
            <time class="post-card-meta-date" datetime="2016-06-10">Jun 10, 2016</time>
                <span class="post-card-meta-length">3 min read</span>
        </footer>

    </div>

</article>
                </div>
            </aside>



    </div>

    <footer class="site-footer outer">
        <div class="inner">
            <section class="copyright"><a href="http://localhost:2368">Rey Pham</a> &copy; 2022</section>
            <nav class="site-footer-nav">
                <ul class="nav">
    <li class="nav-sign-up"><a href="#/portal/">Sign up</a></li>
</ul>

            </nav>
            <div><a href="https://ghost.org/" target="_blank" rel="noopener">Powered by Ghost</a></div>
        </div>
    </footer>

</div>


<script
    src="https://code.jquery.com/jquery-3.5.1.min.js"
    integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0="
    crossorigin="anonymous">
</script>
<script src="/assets/built/casper.js?v=819dc3dcc5"></script>
<script>
$(document).ready(function () {
    // Mobile Menu Trigger
    $('.gh-burger').click(function () {
        $('body').toggleClass('gh-head-open');
    });
    // FitVids - Makes video embeds responsive
    $(".gh-content").fitVids();
});
</script>



</body>
</html>
