<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>JsonBatch - Journey from zero to full-fledged Batch Engine - part 1</title>
    <link rel="stylesheet" href="/assets/built/screen.css?v=5d68560f01">

    <meta name="description" content="The idea &amp; the first prototype" />
    <link rel="canonical" href="http://localhost:2368/jsonbatch-the-jouney-part-1/" />
    <meta name="referrer" content="no-referrer-when-downgrade" />
    <link rel="amphtml" href="http://localhost:2368/jsonbatch-the-jouney-part-1/amp/" />
    
    <meta property="og:site_name" content="Rey Pham" />
    <meta property="og:type" content="article" />
    <meta property="og:title" content="JsonBatch - Journey from zero to full-fledged Batch Engine - part 1" />
    <meta property="og:description" content="The idea &amp; the first prototype" />
    <meta property="og:url" content="http://localhost:2368/jsonbatch-the-jouney-part-1/" />
    <meta property="og:image" content="https://i.imgur.com/hqxvO54.jpg" />
    <meta property="article:published_time" content="2020-06-16T04:15:16.000Z" />
    <meta property="article:modified_time" content="2020-06-16T04:18:06.000Z" />
    <meta property="article:tag" content="Java" />
    <meta property="article:tag" content="JSON" />
    <meta property="article:tag" content="Batch" />
    
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="JsonBatch - Journey from zero to full-fledged Batch Engine - part 1" />
    <meta name="twitter:description" content="The idea &amp; the first prototype" />
    <meta name="twitter:url" content="http://localhost:2368/jsonbatch-the-jouney-part-1/" />
    <meta name="twitter:image" content="https://i.imgur.com/hqxvO54.jpg" />
    <meta name="twitter:label1" content="Written by" />
    <meta name="twitter:data1" content="Rey Pham" />
    <meta name="twitter:label2" content="Filed under" />
    <meta name="twitter:data2" content="Java, JSON, Batch" />
    <meta property="og:image:width" content="2000" />
    <meta property="og:image:height" content="884" />
    
    <script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "Article",
    "publisher": {
        "@type": "Organization",
        "name": "Rey Pham",
        "url": "http://localhost:2368/",
        "logo": {
            "@type": "ImageObject",
            "url": "http://localhost:2368/favicon.ico",
            "width": 48,
            "height": 48
        }
    },
    "author": {
        "@type": "Person",
        "name": "Rey Pham",
        "image": {
            "@type": "ImageObject",
            "url": "//www.gravatar.com/avatar/cd4c74c822ad731f7f283008b81d597d?s=250&d=mm&r=x",
            "width": 250,
            "height": 250
        },
        "url": "http://localhost:2368/author/rey-2/",
        "sameAs": []
    },
    "headline": "JsonBatch - Journey from zero to full-fledged Batch Engine - part 1",
    "url": "http://localhost:2368/jsonbatch-the-jouney-part-1/",
    "datePublished": "2020-06-16T04:15:16.000Z",
    "dateModified": "2020-06-16T04:18:06.000Z",
    "keywords": "Java, JSON, Batch",
    "description": "The idea &amp; the first prototype",
    "mainEntityOfPage": {
        "@type": "WebPage",
        "@id": "http://localhost:2368/"
    }
}
    </script>

    <meta name="generator" content="Ghost 5.23" />
    <link rel="alternate" type="application/rss+xml" title="Rey Pham" href="http://localhost:2368/rss/" />
    
    <script defer src="https://cdn.jsdelivr.net/ghost/sodo-search@~1.1/umd/sodo-search.min.js" data-key="cacff2152241882fce973f1f10" data-styles="https://cdn.jsdelivr.net/ghost/sodo-search@~1.1/umd/main.css" data-sodo-search="http://localhost:2368/" crossorigin="anonymous"></script>
    <script defer src="/public/cards.min.js?v=5d68560f01"></script><style>:root {--ghost-accent-color: #FF1A75;}</style>
    <link rel="stylesheet" type="text/css" href="/public/cards.min.css?v=5d68560f01">
</head>

<body class="post-template tag-java tag-json tag-batch is-head-stacked">
<div class="gh-site">

    <header id="gh-head" class="gh-head gh-outer">
        <div class="gh-head-inner gh-inner">
            <div class="gh-head-brand">
                <div class="gh-head-brand-wrapper">
                    <a class="gh-head-logo" href="http://localhost:2368">
                            Rey Pham
                    </a>
                </div>
                <button class="gh-search gh-icon-btn" data-ghost-search><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" width="20" height="20"><path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg></button>
                <button class="gh-burger"></button>
            </div>

            <nav class="gh-head-menu">
                <ul class="nav">
    <li class="nav-home"><a href="https://www.rey5137.com/">Home</a></li>
    <li class="nav-works"><a href="http://www.rey5137.com/works/">Works</a></li>
    <li class="nav-about"><a href="http://www.rey5137.com/about/">About</a></li>
    <li class="nav-contact"><a href="http://www.rey5137.com/contact/">Contact</a></li>
</ul>

                        <button class="gh-search gh-icon-btn" data-ghost-search><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" width="20" height="20"><path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg></button>
            </nav>

            <div class="gh-head-actions">
            </div>
        </div>
    </header>

    

<main id="gh-main" class="gh-main">
    <article class="gh-article post tag-java tag-json tag-batch no-image">

        <header class="gh-article-header gh-canvas">
            <span class="gh-article-meta">
                By <a href="/author/rey-2/">Rey Pham</a>
                    in
                    <a class="gh-article-tag" href="http://localhost:2368/tag/java/">Java</a>
                —
                <time datetime="2020-06-16">Jun 16, 2020</time>
            </span>

            <h1 class="gh-article-title">JsonBatch - Journey from zero to full-fledged Batch Engine - part 1</h1>

                <p class="gh-article-excerpt">The idea &amp; the first prototype</p>

                    </header>

        <div class="gh-content gh-canvas">
            <p>Recently, I have published <a href="https://github.com/rey5137/jsonbatch">JsonBatch</a> - an Engine to run batch requests with JSON based REST APIs. Although it is a small library, I found it quite satisfying to go through all processes, from designing to developing it. So today, I want to share my journey with you.</p><p><strong>I. The idea</strong></p><p>It all started with a requirement for our company product. To support one of our users migrate their own system to our system, we need to provide them an Adapter that will bridge the gap between their APIs to our APIs and maintain it for a while until they finish the migrating process. </p><p>It's a common requirement, but we want to reuse it somehow, so we don't have to repeat the same works with other users. At first, we thinking about providing user a way to config what endpoint that their API will route to, and how to map our response back to their response. Quite straight forward, but the reality is not so simple. Due to the different design of 2 systems, their API will mostly have to call multi-requests and then aggregate all responses.</p><p>That is when an idea came to me. What we need is a Batch Engine that can be configured easily &amp; dynamically.</p><p><strong>II. The first prototype</strong></p><p>So for a Batch Engine, it should take a list of requests, execute sequentially, and collect all responses.</p><figure class="kg-card kg-image-card"><img src="https://i.imgur.com/ez5dZuC.png" class="kg-image" alt loading="lazy"></figure><p>The execution logic is simple, but here comes the first challenge: How to build the request body?</p><p>It's easy if the client can supply all the request bodies, but what if a request body requires data from the response of another request? The Engine needs a way to know how &amp; where to extract data. Because all of the requests &amp; responses will be JSON, so if you want to locate a field, the first answer that came to me is using JsonPath. Fortunately, Java already has a good library <a href="https://github.com/json-path/JsonPath">Jayway's JsonPath</a> that supports all my needs. </p><p>So now we done with the <strong>How</strong> question, next is the <strong>Where</strong> question. The solution I came up with is building a grand JSON contains all the requests &amp; responses. Something like this:</p><pre><code class="language-json">{
 "original": {
   "http_method": "...",
   "url": "...",
   "headers": {
     "header_1": [ "..." ],
     "header_2": [ "..." ],
     ...
   },
   "body": { ... }
 },
 "requests": [
     {
       "http_method": "...",
       "url": "...",
       "headers": {
         "header_1": [ "..." ],
         "header_2": [ "..." ],
         ...
       },
       "body": { ... }
     },
     ...
 ],
 "responses": [
     {
       "status": ...,
       "headers": {
         "header_1": [ "..." ],
         "header_2": [ "..." ],
         ...
       },
       "body": { ... }
     },
     ...
 ]
}</code></pre><p>With that, only 1 problem left: we need a schema format to instruct the Engine build the actual JSON body. A quick search and I found out JSON Schema. But after some research, I think JSON Schema is more suited to validating than generating, and the schema format has a structure that quite different from actual JSON. So I'm left with designing my own custom schema. </p><p>With some experiments, I came up with a schema that's simple but good enough. The schema is same as actual JSON but only string field has a specific format. For example:</p><pre><code class="language-json">{
  "field_1": 1,
  "field_2": "int $.responses[0].body.field_a",
  "field_3": "int[] $.responses[*].body.field_a"
}</code></pre><p>With this schema, the Engine will build a JSON with:</p><ul><li>field_1 = 1</li><li>field_2 is integer, and extract value from JsonPath: <strong>$.responses[0].body.field_a</strong></li><li>field_3 is integer array, and extract value from JsonPath: <strong>$.responses[*].body.field_a</strong></li></ul><p>An actual JSON will look like that:</p><pre><code class="language-json">{
  "field_1": 1,
  "field_2": 2,
  "field_3": [2, 3, 4]
}</code></pre><p>You can see the structure of schema &amp; actual is quite similar.</p><p>Now, after all the pieces came together, it took me about 1 week to code this first prototype. In the next part, I will share how this prototype continues to evolve.</p>
        </div>


        <footer class="gh-article-footer gh-canvas">
            <nav class="gh-navigation">
                <div class="gh-navigation-previous">
                        <a class="gh-navigation-link" href="/bad-chunk-header-mystery/">
                            <span class="gh-navigation-label"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
    <line x1="19" y1="12" x2="5" y2="12"></line>
    <polyline points="12 19 5 12 12 5"></polyline>
</svg> Previous issue</span>
                            <h4 class="gh-navigation-title">Bad chunk header mystery</h4>
                        </a>
                </div>

                <div class="gh-navigation-middle"></div>

                <div class="gh-navigation-next">
                        <a class="gh-navigation-link" href="/power_up_rest_service_with_batch_api/">
                            <span class="gh-navigation-label">Next issue <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
    <line x1="5" y1="12" x2="19" y2="12"></line>
    <polyline points="12 5 19 12 12 19"></polyline>
</svg></span>
                            <h4 class="gh-navigation-title">Power up your REST service with Batch API</h4>
                        </a>
                </div>
            </nav>
        </footer>

    </article>
</main>




    <footer class="gh-foot gh-outer">
        <div class="gh-foot-inner gh-inner">
            <div class="gh-copyright">
                Rey Pham © 2022
            </div>

            <nav class="gh-foot-menu">
                
            </nav>

            <div class="gh-powered-by">
                <a href="https://ghost.org/" target="_blank" rel="noopener">Powered by Ghost</a>
            </div>
        </div>
    </footer>

</div>

    <div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="pswp__bg"></div>

    <div class="pswp__scroll-wrap">
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        <div class="pswp__ui pswp__ui--hidden">
            <div class="pswp__top-bar">
                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
                <button class="pswp__button pswp__button--share" title="Share"></button>
                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)"></button>
            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>
        </div>
    </div>
</div>
<script src="/assets/built/main.min.js?v=5d68560f01"></script>



</body>

</html>